spec:
  name: supabase

  ingress:
    rules:
      - match:
          path:
            prefix: /rest/v1
        component:
          name: rest
          rewrite: /
      - match:
          path:
            prefix: /
        component:
          name: studio
  
  services:
    - name: studio
      image:
        registry_type: DOCKER_HUB
        registry: supabase
        repository: studio
      http_port: 3000
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      health_check:
        http_path: /api/platform/profile
        initial_delay_seconds: 30
        period_seconds: 10
        timeout_seconds: 5
        failure_threshold: 3
      envs:
        - key: STUDIO_PG_META_URL
          value: http://meta:8080
        - key: POSTGRES_PASSWORD
          scope: RUN_TIME
          value: ${supabase-db.PASSWORD}
        - key: DEFAULT_ORGANIZATION_NAME
          value: "My Organization"
        - key: DEFAULT_PROJECT_NAME
          value: "My Project"
        - key: SUPABASE_URL
          scope: RUN_TIME
          value: ${APP_URL}
        - key: SUPABASE_PUBLIC_URL
          scope: RUN_TIME
          value: ${APP_URL}
        - key: NEXT_PUBLIC_ENABLE_LOGS
          value: "false"

        # Template Tracking (for DigitalOcean analytics)
        - key: APPPLAT_BASE_TEMPLATE
          value: "supabase"
        - key: APPPLAT_TEMPLATE_TYPE
          value: "simple"
        - key: APPPLAT_TEMPLATE_COMMIT_SHA
          value: ${_self.COMMIT_HASH}

    # PostgREST - REST API server for Database (HTTP accessible)
    - name: rest
      image:
        registry_type: DOCKER_HUB
        registry: postgrest
        repository: postgrest
        tag: v12.2.3
      http_port: 3000
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      health_check:
        http_path: /
        initial_delay_seconds: 10
        period_seconds: 10
        timeout_seconds: 3
        failure_threshold: 3
      envs:
        - key: PGRST_DB_URI
          scope: RUN_TIME
          value: ${supabase-db.DATABASE_URL}
        - key: PGRST_DB_SCHEMAS
          value: public
        # Anonymous role for unauthenticated requests
        # Using the default database user since App Platform dev databases
        # don't allow creating custom roles
        - key: PGRST_DB_ANON_ROLE
          value: ${supabase-db.USERNAME}
        - key: PGRST_DB_POOL
          value: "10"
        - key: PGRST_SERVER_PORT
          value: "3000"

    # Meta - Database Management API (internal only, accessed by Studio)
    - name: meta
      image:
        registry_type: DOCKER_HUB
        registry: supabase
        repository: postgres-meta
        tag: v0.84.2
      internal_ports:
        - 8080
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      envs:
        - key: PG_META_PORT
          value: "8080"
        - key: DATABASE_URL
          scope: RUN_TIME
          value: ${supabase-db.DATABASE_URL}

  databases:
    - name: supabase-db
      engine: PG
      production: false
      version: "17"
      cluster_name: supabase-db
